
@section Styles{
    @*<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0-alpha3/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
        <link href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css" rel="stylesheet" />*@
    <link href="https://cdn.datatables.net/v/bs5/dt-1.13.5/af-2.6.0/b-2.4.0/b-html5-2.4.0/date-1.5.0/sb-1.5.0/sl-1.7.0/datatables.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.css" rel="stylesheet">


    <style>
        thead {
            background-color: goldenrod;
            color: white;
        }

        .vertical-align-middle {
            vertical-align: middle;
        }

        .text-gray {
            color: lightgray !important;
        }
    </style>
}

<h2>留言列表列表</h2>

<table class="table table-striped table-hover w-100" id="postsCommentsTable">
    <thead>
        <tr>
            <td>看板名稱</td>
            <td>類型</td>
            <td>內容</td>
            <td>會員名</td>
            <td>發表時間</td>
            <td>Like數</td>
            <td>Unlike數</td>
            <td>回應數</td>
            <td>顯示狀態</td>
            <td>:D</td>
        </tr>
    </thead>
</table>


<div class="modal" id="myModal" tabindex="-2">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="textContent"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="editBtn">編輯</button>
                <button type="button" class="btn btn-secondary" id="closeBtn" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>


@section Scripts{
    @*<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0-alpha3/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap.min.js"></script>
        <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
        <script src="https://cdn.datatables.net/responsive/2.4.1/js/responsive.bootstrap.min.js"></script>
        <script src="https://cdn.datatables.net/v/bs5/jq-3.6.0/dt-1.13.1/datatables.min.js"></script>*@

    <script src="https://cdn.datatables.net/v/bs5/dt-1.13.5/af-2.6.0/b-2.4.0/b-html5-2.4.0/date-1.5.0/sb-1.5.0/sl-1.7.0/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.js"></script>

    <script>

        const baseAddress = 'https://localhost:44398';
        let thisData;
        let boardId;
        let Id;

        $(document).ready(function () {
            function DelePost() {
                $.ajax({
                    type: 'DELETE',
                    url: `${baseAddress}/api/PostsApi/${Id}`
                },
                )
                    .done(data => {
                        if (data.IsSuccess) {
                            Swal.fire({
                                icon: 'success',
                                title: '成功',
                                text: JSON.stringify(data.Message)
                            }).then(() => {
                                $('#postsCommentsTable').DataTable().ajax.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '失敗',
                                text: JSON.stringify(data.Message)
                            });
                        }
                    })
                    .fail(err => {
                        Swal.fire({
                            icon: 'error',
                            title: '失敗',
                            text: err.statusText
                        })
                    })
            }
            function DeleComm() {
                $.ajax({
                    type: 'DELETE',
                    url: `${baseAddress}/api/CommentsApi/${Id}`
                },
                )
                    .done(data => {
                        if (data.IsSuccess) {
                            Swal.fire({
                                icon: 'success',
                                title: '成功',
                                text: JSON.stringify(data.Message)
                            }).then(() => {
                                $('#postsCommentsTable').DataTable().ajax.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '失敗',
                                text: JSON.stringify(data.Message)
                            });
                        }
                    })
                    .fail(err => {
                        Swal.fire({
                            icon: 'error',
                            title: '失敗',
                            text: err.statusText
                        })
                    })
            }
            function RecoverPost() {
                $.ajax({
                    type: 'PUT',
                    url: `${baseAddress}/api/PostsApi/${Id}`
                },
                )
                    .done(data => {
                        if (data.IsSuccess) {
                            Swal.fire({
                                icon: 'success',
                                title: '成功',
                                text: JSON.stringify(data.Message)
                            }).then(() => {
                                $('#postsCommentsTable').DataTable().ajax.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '失敗',
                                text: JSON.stringify(data.Message)
                            });
                        }
                    })
                    .fail(err => {
                        Swal.fire({
                            icon: 'error',
                            title: '失敗',
                            text: err.statusText
                        })
                    })

            }
            function RecoverComm() {
                $.ajax({
                    type: 'PUT',
                    url: `${baseAddress}/api/CommentsApi/${Id}`
                },
                )
                    .done(data => {
                        if (data.IsSuccess) {
                            Swal.fire({
                                icon: 'success',
                                title: '成功',
                                text: JSON.stringify(data.Message)
                            }).then(() => {
                                $('#postsCommentsTable').DataTable().ajax.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '失敗',
                                text: JSON.stringify(data.Message)
                            });
                        }
                    })
                    .fail(err => {
                        Swal.fire({
                            icon: 'error',
                            title: '失敗',
                            text: err.statusText
                        })
                    })

            }

            let postTable = $('#postsCommentsTable').DataTable
                ({
                    dom: 'Qfrtip',
                    responsive: true,
                    select: true,
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/zh-HANT.json',
                    },
                    ajax: {
                        type: 'GET',
                        url: `${baseAddress}/api/PostsApi`,
                        dataSrc: function (data) { return data; }
                    },
                    columns: [
                        { "data": "BoardName", "className": "text-center vertical-align-middle" },
                        { "data": "Type", "className": "text-center vertical-align-middle" },
                        { "data": "Content", "className": "text-center vertical-align-middle" },
                        { "data": "MemberName", "className": "text-center vertical-align-middle" },
                        { "data": "DateTime", "className": "text-center vertical-align-middle" },
                        { "data": "LikesCount", "className": "text-center vertical-align-middle" },
                        { "data": "UnlikesCount", "className": "text-center vertical-align-middle" },
                        { "data": "CommentsCount", "className": "text-center vertical-align-middle" },
                        {
                            "data": "ActiveFlag",
                            "className": "text-center vertical-align-middle",
                            "render": function (data, type, row) {
                                if (type === "display") {
                                    if (data === true) {
                                        return '<i class="fas fa-check text-success"></i>'; // Font Awesome check icon for true (active)
                                    } else {
                                        return '<i class="fas fa-times text-danger"></i>'; // Font Awesome times icon for false (inactive)
                                    }
                                }
                                return data;
                            }
                        },
                        {
                            data: null,
                            targets: -1,
                            defaultContent: '',
                            render: function (data, type, row) {
                                if (type === "display") {
                                    if (data.Type === 'Post' && data.ActiveFlag === true) {
                                        return '<button class="btn btn-outline-warning changeBtn postDele">隱藏</button>';
                                    }
                                    if (data.Type === 'Comment' && data.ActiveFlag === true) {
                                        return '<button class="btn btn-outline-warning changeBtn commentDele">隱藏</button>';
                                    }
                                    if (data.Type === 'Post' && data.ActiveFlag === false) {
                                        return '<button class="btn btn-outline-light changeBtn postRecover">還原</button>';
                                    }
                                    if (data.Type === 'Comment' && data.ActiveFlag === false) {
                                        return '<button class="btn btn-outline-light changeBtn commentRecover">還原</button>';
                                    }

                                }
                            }
                        }],
                    "bSort": true,
                    "rowCallback": function (row, data) {
                        if (data.ActiveFlag === false) {
                            $("td", row).addClass("text-gray"); // Change text color to gray for rows with ActiveFlag = false
                        }
                        $(row).on("click", function () {
                            Id = data.ID;
                            $('#myModal').modal('show');
                            $('#textContent').text("I'm a post");
                            boardName = data.BoardName;

                            if (data.Type === 'Post') {
                                $('#myModal').modal('show');
                                $('#textContent').text("I'm a post");
                                boardName = data.BoardName;
                            }

                            if (data.Type === 'Comment') {
                                $('#myModal').modal('show');
                                $('#textContent').text("I'm a Comment");
                                boardName = data.BoardName;
                            }
                        })
                    }
                })

            $(document).on("click", ".postDele", function (event) {
                $('#myModal').modal('hide');
                Swal.fire({
                    title: '刪除貼文',
                    text: '此動作將刪除貼文內容，你確定嗎？',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: '確定',
                    cancelButtonText: '取消'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // 使用者選擇確定，執行 SaveEdit()
                        DelePost();
                        $('#postsCommentsTable').DataTable().ajax.reload();
                    }
                })
            })
            $(document).on("click", ".commentDele", function (event) {
                $('#myModal').modal('hide');
                Swal.fire({
                    title: '刪除留言？',
                    text: '此動作將刪除留言內容，你確定嗎？',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: '確定',
                    cancelButtonText: '取消'
                }).then((result) => {
                    if (result.isConfirmed) {
                        DeleComm();
                        $('#postsCommentsTable').DataTable().ajax.reload();
                    }
                })
            })
            $(document).on("click", ".postRecover", function (event) {
                $('#myModal').modal('hide');
                Swal.fire({
                    title: '復原貼文？',
                    text: '此動作將復原推文內容，你確定嗎？',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: '確定',
                    cancelButtonText: '取消'
                }).then((result) => {
                    if (result.isConfirmed) {
                        RecoverPost();
                        $('#postsCommentsTable').DataTable().ajax.reload();
                    }
                })
            })
            $(document).on("click", ".commentRecover", function (event) {
                $('#myModal').modal('hide');
                Swal.fire({
                    title: '復原留言？',
                    text: '此動作將復原評論內容，你確定嗎？',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: '確定',
                    cancelButtonText: '取消'
                }).then((result) => {
                    if (result.isConfirmed) {
                        RecoverComm();
                        $('#postsCommentsTable').DataTable().ajax.reload();
                    }
                })
            })

        });

    </script>
}

